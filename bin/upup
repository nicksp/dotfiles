#!/bin/bash
#
# Get macOS software updates, update Homebrew, npm, dotfiles, VS Code and some other software.
#
# - Run updates:
#
# `upup`
#
# ---
# Author: Nick Plekhanov, https://plekhanov.me
# License: MIT
# https://github.com/nicksp/dotfiles

set -euo pipefail

header() {
  echo "$(tput sgr 0 1)$(tput setaf 6)$1$(tput sgr0)"
}

warning() {
  tput setaf 1
  echo "/!\\ $1 /!\\"
  tput sgr0
}

# Ask for the administrator password upfront
warning "Activate sudo"
sudo echo "Sudo activated!"
echo

# Dotfiles
dotfiles
echo

# macOS
header "Updating macOS systemâ€¦"
sudo softwareupdate -ia --verbose
echo

# App Store
# https://github.com/mas-cli/mas#-%EF%B8%8F-known-issues
header "Updating apps from App Storeâ€¦"
mas upgrade
echo

# Homebrew (formulae + casks without and with auto_updates)
header "Updating Homebrew packagesâ€¦"
outdated_packages=$(brew outdated --greedy)
if [ -n "$outdated_packages" ]; then
  echo "ðŸ“¦ Outdated packages:"
  echo "$outdated_packages"
  brew upgrade --greedy
else
  echo "âœ¨ All packages already up-to-date."
fi
echo

# Cleanup
header "Cleaning up Homebrewâ€¦"
brew cleanup --prune=all
brew doctor || true
echo

# Raycast
header "Updating Raycast and its extensionsâ€¦"
open raycast://extensions/raycast/raycast/check-for-updates
open raycast://extensions/raycast/raycast/check-for-extension-updates
echo

# npm
header "Updating global npm modulesâ€¦"
npm update -g
echo

# VS Code extensions
header "Updating VS Code extensionsâ€¦"
for extension in $(code --list-extensions); do
  # Reinstall each extension (which automatically updates it if there is a newer version)
  code --install-extension $extension --force
done

# Nyan dog!
nyan
